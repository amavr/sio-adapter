<!DOCTYPE html>
<html>

<head>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/png">
    <link rel="stylesheet" href="css/loader-default.css">
    <link rel="stylesheet" href="css/style.css">

    <script src="js/utils.js"></script>
    <script src="js/jquery-3.5.1.slim.min.js"></script>
    <script src="js/popper.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/bootstrap.min.js"></script>


    <script async="false" src="js/ajax.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <title>Log browser</title>
</head>

<body>
    <h1 class="bd-content-title">6.1 log browser</h1>
    <div id="loader" class="loader loader-default"></div>
    <div id="error_box" class="alert alert-warning" style="display: none;"></div>
    <div class="container-fluid">
        <div class="row" style="background-color: #eee;padding-top: 20px;">
            <div class="col-sm">
                <form>
                    <div class="form-group row">
                        <label for="beg_id" class="col-sm-1 col-form-label col-form-label-sm">Start ID</label>
                        <div class="col-sm-1">
                            <input type="number" class="form-control form-control-sm" id="beg_id" placeholder="">
                        </div>
                        <label for="end_id" class="col-sm-1 col-form-label col-form-label-sm">Last ID</label>
                        <div class="col-sm-1">
                            <input type="number" class="form-control form-control-sm" id="end_id" placeholder="">
                        </div>
                        <div class="col-sm-8"><button id="btn_request" class="btn btn-primary"
                                type="button">Запросить</button></div>
                    </div>
                </form>
            </div>
        </div>
        <div class="xrow justify-content-md-center">
            <div class="xcol-sm">
                <div id="chart_box" style="height: 300px;"></div>
            </div>
            <div id="col_tab" class="xcol-sm">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Time</th>
                            <th scope="col">Tag</th>
                            <th scope="col">Message</th>
                            <th scope="col">Key</th>
                        </tr>
                    </thead>
                    <tbody class="tab_rows" style="font-size: 10pt;">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="dlg" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">SQL</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <pre id="dlgText"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div id="templates">
        <div class="block_row">
            <tr class="##lvl##">
                <td>##tag##</td>
                <td>##a_beg####msg####a_end##</td>
            </tr>
        </div>
        <div class="block_row_old">
            <div class="row ##lvl##" style="margin: 8px 0;">
                <!-- <div class="col-sm-1">##dt##</div> -->
                <div class="col-sm-1">##tag##</div>
                <div class="col-sm-11">##a_beg####msg####a_end##</div>
                <!-- <div class="col-sm-2">##key##</div>
                <div class="col-sm-1">##tran_id##</div>
                <div class="col-sm-1">##id##</div> -->
            </div>
        </div>
    </div>


    <script>

        const View = function () {

            this.wait = function (doWait) {
                if (doWait) {
                    document.getElementById('loader').classList.add('is-active');
                }
                else {
                    document.getElementById('loader').classList.remove('is-active');
                }
            }

            this.showError = function (msg) {
                document.getElementById('error_box').innerText = msg;
                document.getElementById('error_box').style.display = 'block';
            }

            this.getInputVal = function (inpId) {
                const val = parseInt(document.getElementById(inpId).value);
                return val ? val : null;
            }

            this.setInputVal = function (inpId, val) {
                if (!val) {
                    val = '';
                }
                document.getElementById(inpId).value = val;
            }

            this.getTopCondition = function () {
                const res = {};
                res.beg_id = this.getInputVal('beg_id');
                res.end_id = this.getInputVal('end_id');
                return res;
            }

            this.showCondition = function (cond) {
                this.setInputVal('beg_id', cond.beg_id);
                this.getInputVal('end_id', cond.end_id);
            }

            this.showModal = function (sql) {
                $('#dlgText').text(sql);
                $('#dlg').modal('show');
            }


            this.showBlockRows = function (rows, onClick) {
                // const html = $('#templates .block_row').html();
                const html = '<tr class="##lvl##"><td>##dt##</td><td>##tag##</td><td>##a_beg####msg####a_end##</td><td>##key##</td></tr>';
                const box = document.querySelector('#col_tab .tab_rows');
                const list_beg = box.querySelectorAll('a.to_fmt');
                for (const a of list_beg) {
                    a.removeEventListener('click', onClick)
                }

                const divs = [];
                for (const row of rows) {
                    const clicked = row.LVL != 'ERR' && row.MSG && row.MSG.length > 80;
                    const hrow = html
                        .replace('##lvl##', row.LVL)
                        .replace('##tag##', row.TAG)
                        .replace('##dt##', row.DT.replace('T', ' ').replace('Z', ' '))
                        .replace('##id##', row.ID)
                        .replace('##key##', row.KEY)
                        .replace('##msg##', row.MSG)
                        .replace('##tran_id##', row.TRAN_ID)
                        .replace('##a_beg##', clicked ? '<a class="to_fmt" href="#">' : '')
                        .replace('##a_end##', clicked ? '</a>' : '');
                    divs.push(hrow);
                }
                box.innerHTML = divs.join('');

                const list_end = box.querySelectorAll('a.to_fmt');
                for (const a of list_end) {
                    a.addEventListener('click', onClick)
                }
            }

            this.constructor = function () {
            }

            this.constructor();
        }

        const Ctrl = function () {
            const me = this;
            const view = new View();
            let chart = null;
            let chart_data = null;

            this.saveCondition = function (cond) {
                setCookie('condition', JSON.stringify(cond));
            }

            this.loadCondition = function () {
                const txt = getCookie('condition');
                if (txt === undefined) {
                    return {
                        beg_id: null,
                        end_id: null
                    }
                }
                return JSON.parse(txt);
            }

            this.getBlockByError = async function (filter) {
                view.wait(true);
                try {
                    const options = {
                        method: "POST",
                        body: JSON.stringify(filter),
                        headers: { "content-type": "application/json" }
                    };
                    const rows = await me.ajax.query("/api/v1/transact", options);
                    view.showBlockRows(rows, me.onRowClick);
                }
                catch (ex) {
                    view.showError(ex.message);
                }
                finally {
                    view.wait(false);
                }
            }

            this.getStat = async function (filter) {
                const cond = filter;
                this.saveCondition(cond);
                view.wait(true);
                try {
                    const options = {
                        method: "POST",
                        body: JSON.stringify(cond),
                        headers: { "content-type": "application/json" }
                    };
                    const errors = await me.ajax.query("/api/v1/errors", options);
                    errors.unshift(['Тип', 'Кол-во']);


                    chart_data = google.visualization.arrayToDataTable(errors);
                    const draw_options = {
                        title: 'Типы ошибок',
                        is3D: true,
                        pieSliceText: 'value',
                    };
                    chart.draw(chart_data, draw_options);

                    view.showBlockRows([], me.onRowClick);

                }
                catch (ex) {
                    view.showError(ex.message);
                }
                finally {
                    view.wait(false);
                }
            }

            this.onRowClick = async function (e) {
                e.preventDefault();
                const data = {};
                data.sql = this.innerText;
                view.wait(true);
                try {
                    const answer = await me.ajax.query("/api/v1/sql", {
                        method: "POST",
                        body: JSON.stringify(data),
                        headers: { "content-type": "application/json" }
                    });

                    view.showModal(answer.sql);
                }
                catch (ex) {
                    console.log(ex);
                }
                finally {
                    view.wait(false);
                }
                return false;
            }

            this.onSubmit = function () {
                const cond = view.getTopCondition();
                this.getStat(cond);
            }

            this.onChartSelect = function () {
                const selectedItem = chart.getSelection()[0];
                if (selectedItem) {
                    var value = chart_data.getValue(selectedItem.row, 0);
                    const cond = view.getTopCondition();
                    cond.msg = value;
                    me.getBlockByError(cond);
                }
            }

            this.init = function () {
                me.ajax = new AJAX();

                chart = new google.visualization.PieChart(document.getElementById('chart_box'));
                google.visualization.events.addListener(chart, 'select', me.onChartSelect);

                const cond = me.loadCondition();
                view.showCondition(cond);
                me.getStat(cond);
            }

            this.constructor = function () {
                this.init();
            }

            this.constructor();
        }

        window.addEventListener('load', function () {
            console.log('READY');
        });

        document.addEventListener('DOMDocumentLoaded', () => {
            document.getElementById('chart_box').addEventListener('click', () => {
                document.getElementById('chart_box').style.display = 'none';
            });
        });


        google.charts.load('current', { 'packages': ['corechart'] });
        google.charts.setOnLoadCallback(() => {
            const ctrl = new Ctrl();
            document.getElementById('btn_request').addEventListener('click', () => {
                console.log('btn request clicked');
                console.log(ctrl.onSubmit());
            });
        });

    </script>

</body>

</html>